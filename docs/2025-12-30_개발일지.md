# RealWalk 개발 일지 - 2025년 12월 30일

**작업자**: Claude Code
**프로젝트**: RealWalk - 금천구 상권 분석 MVP
**작업 시간**: 2025-12-30

---

## 📋 오늘 완료한 작업

### 1. 프로젝트 초기 설정 ✅

#### 1.1 프로젝트 구조 생성

```
realwalk/
├── backend/
│   ├── server.js              # Express 서버
│   ├── controllers/
│   │   └── analysisController.js
│   ├── dao/                   # NEW! DAO 패턴 구현
│   │   ├── bldg.dao.js
│   │   └── poi.dao.js
│   ├── routes/
│   │   └── analysis.js
│   └── utils/
│       ├── database.js        # PostgreSQL 연결
│       └── geocoder.js        # 카카오 Geocoding
├── frontend/
│   ├── index.html
│   ├── css/style.css
│   └── js/
│       ├── app.js
│       ├── map.js
│       └── api.js
└── .env
```

#### 1.2 Dependencies 설치

- **Backend**:

  - express (^4.18.2)
  - pg (^8.16.3) - PostgreSQL 클라이언트
  - @turf/turf (^6.5.0) - GIS 분석
  - axios (^1.6.2) - HTTP 클라이언트
  - dotenv (^16.3.1) - 환경변수
  - cors (^2.8.5) - CORS 처리

- **Frontend**:
  - Leaflet.js (CDN) - 지도
  - Turf.js (CDN) - 클라이언트 GIS

#### 1.3 환경 설정 파일

```env
# PostgreSQL Database
DB_HOST=
DB_PORT=
DB_USER=
DB_PASSWORD=
DB_NAME=

# Kakao API
KAKAO_REST_API_KEY=
KAKAO_JS_API_KEY=
```

---

### 2. 데이터베이스 연결 구축 ✅

#### 2.1 PostgreSQL + PostGIS 연결

- **파일**: `backend/utils/database.js`
- **연결 방식**: Connection Pool (최대 20개 연결)
- **기능**:
  - `testConnection()` - 연결 테스트
  - `query()` - 쿼리 실행 헬퍼
  - `transaction()` - 트랜잭션 처리

#### 2.2 데이터베이스 현황

- **스키마**: `KOR` (대문자 주의!)
- **테이블**:

  - `KOR.BLDG` - 건물 데이터 (15,442개)

    - bldg_id, sig_cd, lotno_addr, road_nm_addr, bldg_nm
    - bldg_geom (PostGIS GEOMETRY)
    - gro_flo_co (지상층수), und_flo_co (지하층수)
    - bdtyp_cd (건물유형코드)

  - `KOR.POI` - 관심지점 데이터
    - poi_id, poi_nm, ctgry_group_nm
    - poi_geom (PostGIS POINT, SRID 4326)

#### 2.3 공간 쿼리 최적화

- ST_DWithin 사용 (반경 검색)
- ST_Distance 사용 (거리 계산)
- ST_AsGeoJSON 사용 (GeoJSON 변환)
- **중요**: 반경을 미터 단위로 직접 전달 (타입 에러 방지)

---

### 3. DAO 패턴 구현 ✅

#### 3.1 Building DAO (`backend/dao/bldg.dao.js`)

```javascript
// 주요 함수
-findNearbyBuildings(lat, lng, radiusKm) - // 반경 내 건물 조회
  findById(bldgId) - // ID로 건물 조회
  countAllBuildings() - // 전체 건물 수
  findAll(limit, offset); // 페이징 조회
```

**핵심 쿼리 예시**:

```sql
SELECT bldg_id, lotno_addr, road_nm_addr, bldg_nm,
       ST_AsGeoJSON(bldg_geom)::json as geometry,
       ST_Distance(bldg_geom::geography,
                   ST_SetSRID(ST_MakePoint($2, $1), 4326)::geography) as distance
FROM kor.bldg
WHERE ST_DWithin(bldg_geom::geography,
                 ST_SetSRID(ST_MakePoint($2, $1), 4326)::geography,
                 $3)  -- 미터 단위
ORDER BY distance
LIMIT 100;
```

#### 3.2 POI DAO (`backend/dao/poi.dao.js`)

```javascript
// 주요 함수
-findNearbyPOIs(lat, lng, radiusKm, category) - // 반경 내 POI 조회
  findByCategory(category) - // 카테고리별 조회
  getAllCategories() - // 전체 카테고리 목록
  searchByName(name) - // 이름 검색
  countAllPOIs(); // 전체 POI 수
```

---

### 4. 카카오 API 연동 ✅

#### 4.1 Geocoding 구현 (`backend/utils/geocoder.js`)

- **기능**: 주소 → 좌표 변환
- **API**: 카카오 로컬 API - 주소 검색
- **엔드포인트**: `https://dapi.kakao.com/v2/local/search/address.json`

**사용 예시**:

```javascript
const result = await geocodeAddress("서울시 금천구 시흥대로 73길 70");
// 결과: { lat: 37.4570656519531, lng: 126.896036850324, address: "..." }
```

#### 4.2 역지오코딩 (선택 구현)

- 좌표 → 주소 변환
- 향후 지도 클릭 기능에 활용 가능

---

### 5. 금천구 중심 MVP 구축 ✅

#### 5.1 금천구 범위 체크

```javascript
// 대략적인 금천구 경계 (MVP용)
const bounds = {
  minLat: 37.436,
  maxLat: 37.491,
  minLng: 126.886,
  maxLng: 126.918,
};
```

#### 5.2 분석 로직 (`backend/controllers/analysisController.js`)

**분석 프로세스**:

1. 주소 입력 → 카카오 API로 좌표 변환
2. PostgreSQL에서 반경 500m 내 데이터 조회
   - 건물 데이터
   - POI 데이터
   - 카테고리 정보
3. 경쟁업체 필터링 (업종별)
4. 점수 계산
5. 추천 전략 생성

**점수 계산 공식**:

```javascript
점수 = (유동점수 × 0.4) +
       (접근성점수 × 0.2) +
       (경쟁점수 × 0.3) +
       (환경점수 × 0.1)
```

**유동량 추정 (MVP 버전)**:

```javascript
추정유동량 = POI수 × 150 + 건물수 × 50
체류가능유동 = 추정유동량 × 0.35
```

#### 5.3 업종별 카테고리 매핑

```javascript
const categoryMap = {
  cafe: ["카페", "커피", "카페/디저트"],
  convenience: ["편의점", "CVS"],
  chicken: ["치킨", "통닭"],
  restaurant: ["음식점", "한식", "중식", "일식", "양식"],
};
```

---

### 6. 프론트엔드 구축 ✅

#### 6.1 지도 초기화

- **기본 위치**: 금천구청 (37.4565, 126.8956)
- **줌 레벨**: 14
- **지도 라이브러리**: Leaflet.js

#### 6.2 UI 구성

- **입력 폼**:

  - 주소 입력 (플레이스홀더: 금천구 주소)
  - 업종 선택 (카페, 편의점, 치킨, 음식점, 기타)

- **결과 표시**:
  - 종합 점수 (0-100점)
  - 일평균 유동량
  - 체류 가능 유동
  - 경쟁 업체 수
  - 시장 포화도
  - 추천 전략

#### 6.3 지도 시각화

- ⭐ 분석 위치 마커
- 📍 경쟁업체 마커
- 🔵 500m 도달권 원
- 팝업으로 상세 정보 표시

#### 6.4 UI/UX 개선

- **점수 해석 가이드 추가**:

  - 70점 이상: 추천 입지 ✅
  - 50-70점: 보통 입지 ⚠️
  - 50점 미만: 신중 검토 필요 ❌

- **지표 설명 툴팁 추가**:
  - 💡 아이콘에 마우스 오버 시 설명 표시
  - 각 지표의 의미를 명확하게 전달

---

### 7. 버그 수정 ✅

#### 7.1 PostgreSQL 타입 에러 수정

**문제**:

```
error: invalid input syntax for type integer: "0.5"
```

**원인**:

- SQL 쿼리에서 `$3 * 1000` 형태로 사용
- PostgreSQL이 파라미터 타입을 integer로 추론
- 0.5 (float)를 전달하면서 에러 발생

**해결**:

```javascript
// Before
const result = await pool.query(query, [lat, lng, radiusKm]);
// WHERE ST_DWithin(..., $3 * 1000)

// After
const radiusMeters = radiusKm * 1000; // JavaScript에서 미리 계산
const result = await pool.query(query, [lat, lng, radiusMeters]);
// WHERE ST_DWithin(..., $3)
```

#### 7.2 지도 마커 표시 수정

**문제**: 경쟁업체 좌표가 올바르게 표시되지 않음

**해결**: DB 구조에 맞게 수정

```javascript
// Before
const coords = competitor.coordinates ||
               [competitor.geometry?.coordinates[1], ...];

// After
const coords = [competitor.lat, competitor.lng];  // DB에서 직접 제공
```

---

## 📊 현재 시스템 현황

### 데이터 현황

- **건물**: 15,442개 (금천구)
- **POI**: 다수 (카테고리별 분류)
- **분석 반경**: 500m
- **좌표계**: WGS84 (EPSG:4326)

### API 엔드포인트

```
POST /api/analyze        - 상권 분석
GET  /api/data-status    - 데이터 상태 확인
GET  /health             - 서버 헬스 체크
```

### 테스트 완료

- ✅ 데이터베이스 연결
- ✅ Geocoding 기능
- ✅ 금천구 주소 분석
- ✅ 경쟁업체 필터링
- ✅ 지도 시각화
- ✅ 점수 계산

---

## 🔧 알려진 제한사항

### 1. 데이터 제한

- **지역**: 금천구만 지원 (MVP)
- **보행로 데이터 없음**: 현재는 POI/건물 밀집도로 유동량 추정
- **시간대별 데이터 없음**: 평균값만 제공

### 2. 분석 정확도

- 유동량은 **추정값** (POI/건물 수 기반)
- 실제 보행 경로 분석 없음
- 환경 점수 고정값 (50점)

### 3. 기능 제한

- PDF 리포트 미구현
- 히트맵 시각화 없음
- 시간대별 분석 없음
- 과거 분석 이력 저장 없음

---

## 📝 내일(12월 31일) 할 일

### 우선순위 1: 데이터 정확도 개선 🔴

#### 1.1 POI 카테고리 확인 및 매핑 개선

```sql
-- 실제 DB의 카테고리 확인 필요
SELECT DISTINCT ctgry_group_nm, COUNT(*)
FROM kor.poi
GROUP BY ctgry_group_nm
ORDER BY count DESC;
```

**작업**:

- [ ] 실제 DB의 카테고리 목록 추출
- [ ] 업종별 카테고리 매핑 정확도 개선
- [ ] 프론트엔드 업종 선택 옵션 업데이트

#### 1.2 유동량 추정 알고리즘 개선

**현재 (단순 추정)**:

```javascript
추정유동량 = POI수 × 150 + 건물수 × 50
```

**개선 방안**:

- [ ] 건물 층수 고려 (지상층수 × 가중치)
- [ ] 건물 유형별 가중치 적용 (상업/주거/업무)
- [ ] POI 카테고리별 가중치 적용
- [ ] 금천구 평균 유동량 데이터 조사

#### 1.3 경쟁 포화도 공식 개선

**현재**:

```javascript
saturation = Math.min(100, competitorCount * 20);
```

**개선안**:

- [ ] 경쟁업체와의 거리 고려
- [ ] 밀집도 계산 (경쟁업체 / 면적)
- [ ] 업종별 적정 경쟁업체 수 설정

---

### 우선순위 2: 지도 시각화 개선 🟡

#### 2.1 건물 시각화 추가

- [ ] 주요 건물 윤곽선 표시 (폴리곤)
- [ ] 건물 클릭 시 상세 정보 표시
- [ ] 건물 높이에 따른 3D 효과 (선택)

#### 2.2 히트맵 추가

```javascript
// Leaflet.heat 플러그인 사용
- [ ] POI 밀집도 히트맵
- [ ] 추정 유동량 히트맵
- [ ] 색상 스케일 범례 추가
```

#### 2.3 레이어 컨트롤 추가

- [ ] 건물 레이어 on/off
- [ ] 경쟁업체 레이어 on/off
- [ ] 히트맵 레이어 on/off
- [ ] POI 전체 레이어 추가

---

### 우선순위 3: 분석 결과 상세화 🟡

#### 3.1 주변 시설 정보 추가

- [ ] 지하철역까지 거리
- [ ] 버스 정류장 정보
- [ ] 주차장 정보
- [ ] 학교/병원 정보

#### 3.2 분석 리포트 강화

```javascript
// 추가할 섹션
- [ ] 주변 건물 목록 (거리순)
- [ ] 유사 업종 성공 사례
- [ ] 시간대별 예상 유동 패턴 (데이터 있을 경우)
- [ ] 주변 임대료 정보 (데이터 수집 필요)
```

#### 3.3 비교 분석 기능

- [ ] 여러 위치 동시 분석
- [ ] 분석 결과 비교 테이블
- [ ] 최적 입지 추천

---

### 우선순위 4: PDF 리포트 기능 (선택) 🟢

#### 4.1 Puppeteer 설정

```bash
npm install puppeteer
```

#### 4.2 PDF 템플릿 작성

- [ ] A4 사이즈 HTML 템플릿
- [ ] 지도 스크린샷 포함
- [ ] 차트 추가 (Chart.js)
- [ ] 인쇄 최적화 CSS

#### 4.3 다운로드 기능

- [ ] /api/download-pdf/:analysisId 엔드포인트
- [ ] 분석 결과 임시 저장
- [ ] PDF 생성 및 다운로드

---

## 📦 필요한 데이터

### 1. 보행로 네트워크 데이터 (우선순위 높음) 🔴

**필요한 이유**:

- RealWalk의 핵심 차별화 요소
- 실제 보행 가능 경로 기반 분석

**데이터 구조**:

```json
{
  "type": "FeatureCollection",
  "features": [{
    "type": "Feature",
    "geometry": {
      "type": "LineString",
      "coordinates": [[lng, lat], ...]
    },
    "properties": {
      "path_id": "path_001",
      "width": 3.5,              // 보도 폭 (m)
      "traffic": 8500,           // 일평균 유동량
      "direction": "both",       // both/oneway
      "time_pattern": {...}      // 시간대별 유동 패턴
    }
  }]
}
```

**요청사항**:

- [ ] LBS Tech에 금천구 보행로 데이터 요청
- [ ] 데이터 형식: GeoJSON
- [ ] 필수 속성: 좌표, 유동량
- [ ] 선택 속성: 시간대별 패턴, 보도 폭

**DB 테이블 설계**:

```sql
CREATE TABLE kor.walking_path (
  path_id SERIAL PRIMARY KEY,
  path_geom GEOMETRY(LINESTRING, 4326),
  width NUMERIC,
  avg_traffic INTEGER,
  direction VARCHAR(10),
  time_pattern JSONB,
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

### 2. 시간대별 유동 패턴 데이터 🟡

**필요한 형식**:

```json
{
  "weekday": {
    "hour_0": 100, "hour_1": 50, ..., "hour_23": 200
  },
  "weekend": {
    "hour_0": 150, "hour_1": 80, ..., "hour_23": 300
  }
}
```

**활용 방안**:

- 업종별 최적 시간대 분석
- "점심 장사 유리" vs "저녁 장사 유리" 판단
- 24시간 영업 vs 주간 영업 추천

---

### 3. 건물 상세 정보 보강 🟡

**현재 있는 정보**:

- 건물명, 주소, 층수, 건물유형코드

**추가 필요 정보**:

```javascript
{
  "building_use": "상업",           // 건물 용도 (상세)
  "floor_area": 500,               // 연면적 (㎡)
  "year_built": 2015,              // 건축년도
  "parking_spaces": 50,            // 주차 대수
  "rent_price": 5000000,           // 임대료 (월, 선택)
  "tenant_types": ["음식점", "카페"]  // 입점 업종
}
```

**조사 방법**:

- 공공 데이터 포털 (건축물대장)
- 상가정보 API
- 부동산 정보 크롤링 (법적 검토 필요)

---

### 4. 교통 정보 🟢

#### 4.1 지하철역 정보

```javascript
{
  "station_name": "독산역",
  "line": "1호선",
  "exits": [
    { "exit_num": 1, "lat": 37.466, "lng": 126.893 },
    { "exit_num": 2, "lat": 37.467, "lng": 126.894 }
  ],
  "daily_users": 25000  // 일평균 이용객
}
```

**데이터 출처**:

- 서울 열린데이터 광장
- 국토교통부 공공데이터

#### 4.2 버스 정류장 정보

- 정류장 위치
- 노선 정보
- 배차 간격

---

### 5. 인구 통계 데이터 (선택) 🟢

**활용도**:

- 주변 거주 인구
- 직장 인구 (유동 인구)
- 연령대 분포
- 소득 수준

**데이터 출처**:

- 통계청 (행정동 단위)
- 서울시 빅데이터 캠퍼스

---

## 🎯 다음 마일스톤

### Week 1 (12/31 ~ 1/5)

- [ ] 금천구 MVP 완성도 향상
- [ ] 데이터 정확도 개선
- [ ] UI/UX 개선
- [ ] 테스트 케이스 작성

### Week 2 (1/6 ~ 1/12)

- [ ] 보행로 데이터 연동 (데이터 수신 시)
- [ ] 네트워크 분석 알고리즘 구현
- [ ] PDF 리포트 기능 완성

### Week 3 (1/13 ~ 1/19)

- [ ] 금천구 외 지역 확장 준비
- [ ] 서울시 전역 데이터 조사
- [ ] 확장성 있는 구조로 리팩토링

### Week 4 (1/20 ~ 1/26)

- [ ] 베타 테스트
- [ ] 사용자 피드백 수집
- [ ] 성능 최적화

---

## 🐛 알려진 이슈

### 해결 필요

1. **금천구 외 지역 분석 시 경고만 표시**

   - 현재는 경고만 하고 분석 진행
   - 개선: 사용자에게 명확히 알림

2. **POI 카테고리 매핑 불완전**

   - 실제 DB 카테고리 확인 필요
   - 누락되는 경쟁업체 있을 수 있음

3. **유동량 추정 정확도 낮음**
   - 실제 보행로 데이터 없이 추정
   - 개선 우선순위 높음

### 모니터링 필요

1. **대용량 데이터 조회 성능**

   - 현재 LIMIT 100
   - 전체 데이터 조회 시 최적화 필요

2. **PostgreSQL 연결 풀 관리**
   - 최대 20개 연결
   - 트래픽 증가 시 조정 필요

---

## 📚 참고 자료

### 프로젝트 문서

- `CLAUDE.md` - Claude Code 가이드
- `README.md` - 프로젝트 개요
- `DATA_REQUIREMENTS.md` - 필요한 데이터 명세
- `.claude/project-context.md` - 프로젝트 컨텍스트

### API 문서

- 카카오 로컬 API: https://developers.kakao.com/docs/latest/ko/local/dev-guide
- Leaflet: https://leafletjs.com/reference.html
- PostGIS: https://postgis.net/docs/

### 기존 API 서버 참고

- `C:/KHJ/LBSTech/api-server/src/api/bldg/`
- `C:/KHJ/LBSTech/api-server/src/api/poi/`

---

## 💡 아이디어 메모

### 장기 개선 사항

1. **AI 추천 시스템**

   - 머신러닝으로 성공 패턴 학습
   - 유사 업종 성공 사례 매칭

2. **경쟁사 모니터링**

   - 신규 경쟁업체 알림
   - 폐업 정보 수집

3. **임대료 예측**

   - 주변 임대료 정보 수집
   - 적정 임대료 산정

4. **시뮬레이션 기능**
   - "만약 이 위치에 카페를 열면?" 시뮬레이션
   - 매출 예측 모델

---

## 📞 연락처 및 협업

### LBS Tech 담당자

- 데이터 문의: [담당자 연락처]
- 보행로 데이터 요청 진행 중

### 다음 미팅

- 일시: TBD
- 안건: 보행로 데이터 형식 확정, MVP 데모

---

**작성일**: 2025-12-30
**다음 업데이트**: 2025-12-31
